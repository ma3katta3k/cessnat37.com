<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cessna T-37 Aircraft Spares</title>
  <meta name="description" content="Cessna T-37 aircraft spares list with search & filters.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sticky-col{position:sticky;left:0;background:#fff;box-shadow:1px 0 0 #e5e7eb}
    .tg td,.tg th{border-bottom:1px solid #e5e7eb}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white border-b">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4">
      <h1 class="text-2xl font-bold">Cessna T-37 Aircraft Spares</h1>
      <p class="text-sm text-gray-600 mt-1">Browse inventory. Use search & filters.</p>
    </div>
  </header>

  <!-- Filters -->
  <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <label class="block">
        <span class="text-sm font-medium">Search</span>
        <input id="q" type="search" placeholder="Part #, NSN, Desc…" class="mt-1 w-full rounded-lg border px-3 py-2"/>
      </label>
      <label class="block">
        <span class="text-sm font-medium">Condition</span>
        <select id="cond" class="mt-1 w-full rounded-lg border px-3 py-2">
          <option value="">All</option>
          <option>NS</option><option>SV</option><option>OH</option><option>AR</option><option>RP</option>
        </select>
      </label>
      <label class="block">
        <span class="text-sm font-medium">Min Qty</span>
        <input id="minqty" type="number" min="0" class="mt-1 w-full rounded-lg border px-3 py-2"/>
      </label>
      <div class="flex items-end gap-2">
        <button id="clear" class="rounded-lg border px-3 py-2" type="button">Clear</button>
      </div>
    </div>
  </section>

  <!-- Table -->
  <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pb-12">
    <div class="overflow-auto rounded-xl border bg-white">
      <table class="w-full tg" role="table" aria-label="Inventory list">
        <thead class="bg-gray-100 text-left text-sm">
          <tr>
            <th class="p-3 sticky-col">Part Number</th>
            <th class="p-3">NSN</th>
            <th class="p-3">Alt. P/N</th>
            <th class="p-3">Description</th>
            <th class="p-3">Cond</th>
            <th class="p-3">Qty</th>
          </tr>
        </thead>
        <tbody id="rows" class="text-sm"></tbody>
      </table>
    </div>
    <p id="count" class="mt-3 text-sm text-gray-600">Loading…</p>
  </section>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (() => {
    const DATA_URL = '/inventory/t37.csv'; // local CSV (make sure this file exists)

    // DOM
    const rows   = document.getElementById('rows');
    const q      = document.getElementById('q');
    const cond   = document.getElementById('cond');
    const minqty = document.getElementById('minqty');
    const count  = document.getElementById('count');
    const clear  = document.getElementById('clear');

    // Surface any JS error in the UI
    window.onerror = (msg) => { if (count) count.textContent = 'Error: ' + msg; };

    let inventory = [];

    // Support either simple headers (pn,nsn,alt,desc,cond,qty) or ERP headers
    function normalizeRow(r){
      const get = (o,...k)=>k.find(x=>Object.prototype.hasOwnProperty.call(o,x) && o[x] !== '')||null;
      const s = v => (v==null ? '' : String(v).trim());
      const n = v => { const m = String(v||'').replace(/[^0-9-]/g,''); return m ? parseInt(m,10) : 0; };

      const pnK   = get(r,'pn','PN','PartNumber','PARTNUMBER');
      const nsnK  = get(r,'nsn','NSN');
      const altK  = get(r,'alt','ALT','AlternatePartNumber','ALTERNATEPARTNUMBER');
      const descK = get(r,'desc','DESC','Description','DESCRIPTION');
      const condK = get(r,'cond','COND','Condition','CONDITIONCD');
      const qtyK  = get(r,'qty','Qty','QUANTITY');

      return {
        pn:   s(pnK   ? r[pnK]   : r.pn),
        nsn:  s(nsnK  ? r[nsnK]  : r.nsn),
        alt:  s(altK  ? r[altK]  : r.alt),
        desc: s(descK ? r[descK] : r.desc),
        cond: s(condK ? r[condK] : r.cond),
        qty:  n(qtyK  ? r[qtyK]  : r.qty)
      };
    }

    function render(){
      const term = (q?.value || '').toLowerCase();
      const c    = cond?.value || '';
      const mq   = Number(minqty?.value || 0);

      const filtered = inventory.filter(r => {
        const hay = (r.pn + ' ' + r.nsn + ' ' + r.alt + ' ' + r.desc).toLowerCase();
        return hay.includes(term) && (!c || r.cond === c) && ((r.qty||0) >= mq);
      });

      rows.innerHTML = '';
      for (const r of filtered){
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        const tdPN  = document.createElement('td'); tdPN.className  = 'p-3 sticky-col font-medium'; tdPN.textContent  = r.pn || '';
        const tdNSN = document.createElement('td'); tdNSN.className = 'p-3'; tdNSN.textContent = r.nsn || '';
        const tdAlt = document.createElement('td'); tdAlt.className = 'p-3'; tdAlt.textContent = r.alt || '';
        const tdDes = document.createElement('td'); tdDes.className = 'p-3'; tdDes.textContent = r.desc || '';
        const tdCon = document.createElement('td'); tdCon.className = 'p-3'; tdCon.textContent = r.cond || '';
        const tdQty = document.createElement('td'); tdQty.className = 'p-3'; tdQty.textContent = (r.qty ?? '').toString();

        tr.appendChild(tdPN); tr.appendChild(tdNSN); tr.appendChild(tdAlt);
        tr.appendChild(tdDes); tr.appendChild(tdCon); tr.appendChild(tdQty);
        rows.appendChild(tr);
      }

      count.textContent = filtered.length + ' line item(s)';
    }

    function loadData(){
      const url = DATA_URL + (DATA_URL.includes('?') ? '&' : '?') + 't=' + Date.now(); // cache-bust
      fetch(url, { cache: 'no-store' })
        .then(res => { if (!res.ok) throw new Error('CSV HTTP ' + res.status); return res.text(); })
        .then(text => {
          Papa.parse(text, {
            header: true, skipEmptyLines: true, dynamicTyping: false,
            complete: (r) => { inventory = r.data.map(normalizeRow); render(); }
          });
        })
        .catch(err => { console.error(err); count.textContent = 'Failed to load data: ' + err.message; });
    }

    // events
    q?.addEventListener('input', render);
    cond?.addEventListener('change', render);
    minqty?.addEventListener('input', render);
    clear?.addEventListener('click', () => { if(q) q.value=''; if(cond) cond.value=''; if(minqty) minqty.value=''; render(); });

    loadData();
  })();
  </script>
</body>
</html>
